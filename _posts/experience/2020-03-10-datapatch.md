---
layout: post
title: 生产环境中datapatch 的基本法
categories: Experiences
date: 2020-03-04 22:10:00
pid: 20200304-221000
pin: 100
---

## 记一次测试用例覆盖不全面导致的线上事故

{% include toc %}

### 背景

目前我们公司在做线上线下同权，在以往，线上的促销比较单一，总的来说就代金劵类和商品折扣类。但是线下有非常丰富的促销类型，如折上折，生日积分增值，会员日积分抵扣多倍，需要使用到促销计算器的中间件来负责计算。

### 需求

为了让线上的订单能够享受线下的优惠且共享优惠额度，同时又减少工作量，我们决定线上的订单也使用线下的促销计算器。


### 问题

线上订单的业务流程比线下要复杂得多。线上会出现单仓不满足拆分发货、商品永久缺货、仓库实物不符导致的出库单无效等问题。
此时，线下的促销数据遇到了线上的业务逻辑，就出现了水土不符的问题：

线下的积分类促销，在线上订单是没有的。例如，我们设计了一个功能，为了解决实物不符而导致的出库单无效，仓库系统的同事可以发起重建出库单指令，让订单系统重新生成新的出库单指派给别的仓库。这时候重新生成的出库单，一些字段没有从旧的出库单复制过来。



### 问题解决

1. 程序修复
2. 数据修复

##### 程序修复

1. 紧急修复程序，因为由于部分数据缺少，先增加字段避免脏数据产生，再考虑优化程序。
2. 由于有灰度发布功能，可以在上班时间进行热部署。

##### 数据修复

1. 大致确定时间发生和影响范围，根据时间发生的时间和影响范围建立临时表
2. 对临时表建立必要的索引。
3. 对临时表进行数据分析，归类。
4. 根据归类总结case。
5. 对需要patch的表建两份数据备份，一份用于备份，一份用于update。
6. 根据不同的case，逐步对第5点的update 表进行修改，建议每个case都做备份。
7. 最终检查update表。
8. update 表和原表做唯一关联，再次检查后update 原表，并检查update 条数和预期是否一致。
9. 第8步update 原表时，逐条更新，批量commit。避免大事务产生。


###  反思

1. 数据过于耦合，财务结算的信息应该独立于出库单。
2. 测试用例不完善，单一功能测试并不能完全覆盖所有场景。